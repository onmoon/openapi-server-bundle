<?php

declare(strict_types=1);

namespace OnMoon\OpenApiServerBundle\CodeGenerator\PhpParserGenerators;

use OnMoon\OpenApiServerBundle\CodeGenerator\Definitions\GeneratedFileDefinition;
use OnMoon\OpenApiServerBundle\CodeGenerator\Definitions\GraphDefinition;
use OnMoon\OpenApiServerBundle\Interfaces\RequestHandler;
use PhpParser\Node\Arg;
use PhpParser\Node\Expr\Array_;
use PhpParser\Node\Expr\ArrayItem;
use PhpParser\Node\Expr\Assign;
use PhpParser\Node\Expr\BinaryOp\Concat;
use PhpParser\Node\Expr\BooleanNot;
use PhpParser\Node\Expr\ClassConstFetch;
use PhpParser\Node\Expr\MethodCall;
use PhpParser\Node\Expr\Variable;
use PhpParser\Node\Name;
use PhpParser\Node\Scalar\String_;
use PhpParser\Node\Stmt\If_;
use PhpParser\Node\Stmt\Return_;
use Psr\Container\ContainerInterface;
use function array_map;
use function Safe\sprintf;

class ServiceSubscriberCodeGenerator extends CodeGenerator
{
    public function generate(GraphDefinition $graphDefinition) : GeneratedFileDefinition
    {
        $subscriberDefinition = $graphDefinition->getServiceSubscriber();

        $fileBuilder = $this->factory->namespace($subscriberDefinition->getNamespace());

        $fileBuilder->addStmt($this->factory->use(ContainerInterface::class));

        $classBuilder = $this
            ->factory
            ->class($subscriberDefinition->getClassName())
            ->setDocComment(sprintf(self::AUTOGENERATED_WARNING, 'class'));

        foreach ($subscriberDefinition->getImplements() as $implement) {
            $classBuilder->implement($implement->getClassName());
            $this->use($fileBuilder, $subscriberDefinition->getNamespace(), $implement);
        }

        //ToDo: move upwards
        $fileBuilder->addStmt($this->factory->use(RequestHandler::class));

        $services = [];
        foreach ($graphDefinition->getSpecifications() as $specification) {
            foreach ($specification->getOperations() as $operation) {
                $services[] = $operation->getServiceInterface()->getClassName();
                $this->use($fileBuilder, $subscriberDefinition->getNamespace(), $operation->getServiceInterface());
            }
        }

        //ToDo: full DocBlock support
        $classBuilder->addStmts(
            [
                $this
                        ->factory
                        ->property('locator')
                        ->makePrivate()
                        ->setType('ContainerInterface'),
                $this
                        ->factory
                        ->method('__construct')
                        ->makePublic()
                        ->addParam(
                            $this->factory->param('locator')->setType('ContainerInterface')
                        )
                        ->addStmt(
                            new Assign(new Variable('this->locator'), new Variable('locator'))
                        ),
                $this
                        ->factory
                        ->method('getSubscribedServices')
                        ->makePublic()
                        ->makeStatic()
                        ->setDocComment('/**
                                         * @inheritDoc
                                         */')
                        ->addStmt(
                            new Return_(
                                new Array_(
                                    array_map(
                                        static fn (string $service) : ArrayItem =>
                                        new ArrayItem(
                                            new Concat(
                                                new String_('?'),
                                                new ClassConstFetch(
                                                    new Name($service),
                                                    'class'
                                                )
                                            )
                                        ),
                                        $services
                                    )
                                )
                            )
                        ),
                $this
                        ->factory
                        ->method('get')
                        ->makePublic()
                        ->setReturnType('?RequestHandler')
                        ->addParam(
                            $this->factory->param('interface')->setType('string')
                        )
                        ->addStmt(
                            new If_(new BooleanNot(new MethodCall(
                                new Variable('this->locator'),
                                'has',
                                [
                                    new Arg(
                                        new Variable('interface')
                                    ),
                                ]
                            )), ['stmts' => [new Return_($this->factory->val(null))]])
                        )
                        ->addStmt(
                            new Return_(
                                new MethodCall(
                                    new Variable('this->locator'),
                                    'get',
                                    [
                                        new Arg(
                                            new Variable('interface')
                                        ),
                                    ]
                                )
                            )
                        ),
            ]
        );

        $fileBuilder->addStmt($classBuilder);

        return new GeneratedFileDefinition(
            $subscriberDefinition,
            $this->printFile($fileBuilder)
        );
    }
}
